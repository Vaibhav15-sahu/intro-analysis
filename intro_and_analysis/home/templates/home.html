<!-- video_app/templates/record_video.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
</head>

<body>
    <h1>Record Your Video Introduction</h1>

    <div>
        <video id="video-preview" width="640" height="480" controls></video>
        <video id="recorded-video" width="640" height="480" controls
            style="display: none; position: absolute; top: 80px; right: 30px;"></video>

        <br><br>    
        <button id="start-recording">Start Recording</button>
        <button id="stop-recording" disabled>Stop Recording</button>
        <button id="retake" disabled>Retake</button>
        <form id="upload-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" name="video-file" id="video-file" style="display: none;">
            <button type="submit" id="upload-btn" disabled>Upload Video</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const videoPreview = document.getElementById('video-preview');
            const recordedVideo = document.getElementById('recorded-video');
            const startRecordingBtn = document.getElementById('start-recording');
            const stopRecordingBtn = document.getElementById('stop-recording');
            const retake = document.getElementById('retake');
            const uploadForm = document.getElementById('upload-form');
            const videoFileInput = document.getElementById('video-file');
            const uploadBtn = document.getElementById('upload-btn');

            let mediaRecorder;
            let recordedChunks = [];

            async function startRecording() {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                videoPreview.srcObject = stream;
                videoPreview.play();
                videoPreview.controls = false;
                mediaRecorder = new MediaRecorder(stream);


                mediaRecorder.ondataavailable = function (event) {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                        console.log(event.data);
                    }
                };

                mediaRecorder.onstop = function () {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    recordedVideo.src = URL.createObjectURL(blob);

                    recordedVideo.style.display = 'block';

                    uploadBtn.removeAttribute('disabled');
                };

                mediaRecorder.start();
                startRecordingBtn.setAttribute('disabled', 'true');
                stopRecordingBtn.removeAttribute('disabled');
            }
            
            function stopRecording() {
                videoPreview.pause()
                mediaRecorder.stop();
                
                retake.removeAttribute('disabled');
                stopRecordingBtn.setAttribute('disabled', 'true');
            }

            function retakeShot(){
                mediaRecorder = null;
                recordedChunks = [];
                startRecording();

                startRecordingBtn.setAttribute('disabled', 'true');
                stopRecordingBtn.setAttribute('disabled', 'true');
                retake.setAttribute('disabled', 'true');
                uploadBtn.setAttribute('disabled', 'true');
            }

            startRecordingBtn.addEventListener('click', startRecording);
            stopRecordingBtn.addEventListener('click', stopRecording);
            retake.addEventListener('click', retakeShot);

            uploadForm.addEventListener('submit', function (event) {
                if (!videoFileInput.files.length) {
                    event.preventDefault();
                    alert('Please record a video first.');
                }
            });
        });
    </script>
</body>

</html>